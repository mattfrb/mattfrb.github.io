<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Beat the Bot — Matthieu Farbos</title>
    <meta name="description" content="Beat the Bot — mini‑jeu de trading simulé." />
    <link rel="prefetch" href="index.html" />
    <link rel="prefetch" href="projets.html" />
    <style>
      html, body { height: 100%; margin: 0; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: #0b0f14; color: #fff; overflow: hidden; opacity: 0; transition: opacity .25s ease; }
      #bg { position: fixed; inset: 0; z-index: 0; }
      #tv-container { position: absolute; inset: 0; width: 100%; height: 100%; z-index: 0; }
      #tv-container > div, #tv-container iframe { position: absolute !important; inset: 0 !important; width: 100% !important; height: 100% !important; pointer-events: none !important; }

      .overlay { position: relative; z-index: 10; height: 100dvh; display: grid; place-items: center; text-align: center; padding: 24px; }

      /* Credits */
      .credit { position: fixed; right: 8px; bottom: 56px; z-index: 1; font-size: 12px; opacity: 0.65; }
      .credit a { color: #fff; }
      .credit-name { position: fixed; left: 28px; bottom: 56px; z-index: 1; font-size: 12px; opacity: 0.75; }

      /* Footer */
      .footer { position: fixed; left: 0; right: 0; bottom: 0; z-index: 20; display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 10px 14px; background: rgba(10,14,18,0.72); border-top: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); font-size: 14px; }
      .footer .links { display: flex; gap: 16px; align-items: center; }
      .footer a { color: #fff; text-decoration: none; opacity: 0.9; }
      .footer a:hover { opacity: 1; text-decoration: underline; }
      .footer .lang { display: flex; align-items: center; gap: 8px; }
      .footer .lang label { opacity: 0.8; }
      .footer .lang button { appearance: none; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.06); color: #fff; padding: 6px 10px; border-radius: 8px; cursor: pointer; font-size: 13px; }
      .footer .lang button:hover { background: rgba(255,255,255,0.12); }
      .footer .lang button.active { background: rgba(66,133,244,0.35); border-color: rgba(66,133,244,0.6); }

      /* Game UI */
      .game { width: min(1100px, 94vw); }
      .chart-wrap { background: rgba(14,18,24,0.85); border: 1px solid rgba(255,255,255,0.1); border-radius: 14px; padding: 8px; box-shadow: 0 6px 24px rgba(0,0,0,0.35); }
      #chart { display: block; width: 100%; height: 480px; border-radius: 8px; }

      .controls { margin-top: 14px; display: flex; align-items: center; gap: 10px; justify-content: center; }
      .controls label { opacity: 0.8; }
      .controls input[type="number"] { width: 80px; padding: 8px 10px; border-radius: 8px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.2); color: #fff; }
      .btn { padding: 10px 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.06); color: #fff; cursor: pointer; }
      .btn:hover { background: rgba(255,255,255,0.12); }
      .btn.buy { border-color: rgba(0,200,120,0.6); background: rgba(0,200,120,0.2); }
      .btn.buy:hover { background: rgba(0,200,120,0.3); }
      .btn.sell { border-color: rgba(240,80,80,0.6); background: rgba(240,80,80,0.2); }
      .btn.sell:hover { background: rgba(240,80,80,0.3); }
      .pos { opacity: 0.9; margin-left: 8px; }

      .hud { position: fixed; right: 8px; z-index: 25; background: rgba(14,18,24,0.82); border: 1px solid rgba(255,255,255,0.12); padding: 8px 10px; border-radius: 10px; font-size: 13px; backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); }
      .hud-top-right { top: 8px; }
      .hud-bottom-right { bottom: 56px; }
      .hud strong { font-weight: 700; }
      .btn-back { margin-top: 14px; display: inline-block; padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); color: #fff; text-decoration: none; background: rgba(255,255,255,0.06); }
      .btn-back:hover { background: rgba(255,255,255,0.12); }
    </style>
  </head>
  <body>
    <div id="bg"><div id="tv-container"></div></div>

    <main class="overlay">
      <div class="game" id="game">
        <div class="hud hud-top-right" id="hud-top">
          <div><span id="lbl-equity">Équité</span>: <strong id="equity">—</strong></div>
          <div><span id="lbl-unreal">PNL latent</span>: <strong id="unrealized">—</strong></div>
        </div>

        <div class="chart-wrap">
          <canvas id="chart"></canvas>
        </div>

        <div class="controls">
          <label for="qty" id="lbl-qty">Quantité</label>
          <input type="number" id="qty" min="1" value="1" />
          <button id="buy" class="btn buy">Acheter</button>
          <button id="sell" class="btn sell">Vendre</button>
          <span class="pos" id="pos">Flat —</span>
        </div>

        <div class="hud hud-bottom-right" id="hud-bottom">
          <div><span id="lbl-real">PNL réalisé</span>: <strong id="realized">—</strong></div>
          <div><span id="lbl-cash">Trésorerie</span>: <strong id="cash">—</strong></div>
        </div>

        <a class="btn-back" href="projets.html" id="back-link">← Retour aux projets</a>
      </div>
    </main>

    <div class="credit">Données et graphique par <a href="https://www.tradingview.com/widget/advanced-chart/" target="_blank" rel="noopener">TradingView</a></div>
    <div class="credit-name">© Matthieu Farbos</div>

    <nav class="footer" aria-label="Navigation bas de page">
      <div class="links">
        <a href="index.html" id="nav-home">Accueil</a>
        <a href="projets.html" id="nav-projects">Projets</a>
      </div>
      <div class="lang" role="group" aria-label="Choix de langue">
        <label>Langue:</label>
        <button type="button" data-lang="fr" aria-pressed="false" id="btn-fr">FR</button>
        <button type="button" data-lang="en" aria-pressed="false" id="btn-en">EN</button>
      </div>
    </nav>

    <script src="https://s3.tradingview.com/tv.js"></script>
    <script>
      // Seamless page transitions (fade)
      function setupTransitions() {
        requestAnimationFrame(() => { document.body.style.opacity = '1'; });
        document.querySelectorAll('a[href]').forEach(a => {
          const href = a.getAttribute('href');
          if (!href || href.startsWith('http') || href.startsWith('#') || a.target === '_blank') return;
          a.addEventListener('click', (e) => {
            e.preventDefault();
            document.body.style.opacity = '0';
            setTimeout(() => { window.location.href = a.href; }, 200);
          });
        });
      }

      const SYMBOL = 'NASDAQ:GOOGL';
      const storageKey = 'site.lang';
      let currentLang = (localStorage.getItem(storageKey) || 'fr');

      function setActiveButtons() {
        const frBtn = document.getElementById('btn-fr');
        const enBtn = document.getElementById('btn-en');
        frBtn.classList.toggle('active', currentLang === 'fr');
        enBtn.classList.toggle('active', currentLang === 'en');
        frBtn.setAttribute('aria-pressed', String(currentLang === 'fr'));
        enBtn.setAttribute('aria-pressed', String(currentLang === 'en'));
      }

      function initChart() {
        const container = document.getElementById('tv-container');
        container.innerHTML = '';
        new TradingView.widget({
          container_id: 'tv-container', autosize: true, symbol: SYMBOL,
          interval: '5', range: '1D', timezone: 'Europe/Paris', theme: 'dark', style: '1',
          locale: currentLang === 'fr' ? 'fr' : 'en', hide_top_toolbar: true, hide_side_toolbar: true,
          allow_symbol_change: false, withdateranges: false, studies: [], backgroundColor: 'rgba(11,15,20,1)'
        });
      }

      function applyLanguage(lang) {
        currentLang = (lang === 'en') ? 'en' : 'fr';
        localStorage.setItem(storageKey, currentLang);
        setActiveButtons();
        const navHome = document.getElementById('nav-home');
        const navProjects = document.getElementById('nav-projects');
        const langLabel = document.querySelector('.lang label');
        const back = document.getElementById('back-link');
        const lQty = document.getElementById('lbl-qty');
        const btnBuy = document.getElementById('buy');
        const btnSell = document.getElementById('sell');
        const lEquity = document.getElementById('lbl-equity');
        const lUnreal = document.getElementById('lbl-unreal');
        const lReal = document.getElementById('lbl-real');
        const lCash = document.getElementById('lbl-cash');
        if (currentLang === 'fr') {
          navHome.textContent = 'Accueil';
          navProjects.textContent = 'Projets';
          langLabel.textContent = 'Langue:';
          back.textContent = '← Retour aux projets';
          lQty.textContent = 'Quantité';
          btnBuy.textContent = 'Acheter';
          btnSell.textContent = 'Vendre';
          lEquity.textContent = 'Équité';
          lUnreal.textContent = 'PNL latent';
          lReal.textContent = 'PNL réalisé';
          lCash.textContent = 'Trésorerie';
        } else {
          navHome.textContent = 'Home';
          navProjects.textContent = 'Projects';
          langLabel.textContent = 'Language:';
          back.textContent = '← Back to projects';
          lQty.textContent = 'Quantity';
          btnBuy.textContent = 'Buy';
          btnSell.textContent = 'Sell';
          lEquity.textContent = 'Equity';
          lUnreal.textContent = 'Unrealized PnL';
          lReal.textContent = 'Realized PnL';
          lCash.textContent = 'Cash';
        }
        if (window.TradingView) initChart();
      }

      if (window.TradingView) { initChart(); }
      else { window.addEventListener('load', initChart); }

      window.addEventListener('DOMContentLoaded', function() {
        setupTransitions();
        setActiveButtons();
        applyLanguage(currentLang);
        document.getElementById('btn-fr').addEventListener('click', () => applyLanguage('fr'));
        document.getElementById('btn-en').addEventListener('click', () => applyLanguage('en'));
      });

      // --- Simple market simulation + PnL ---
      const state = { price: 100, position: 0, avg: 0, cash: 100000, realized: 0 };
      const candles = [];
      const TF = 5000; // 5s per candle
      let lastCandleTime = 0;

      function nextPrice(p) {
        const drift = (Math.random() - 0.5) * 0.6;
        const revert = (100 - p) * 0.002;
        return Math.max(1, p + drift + revert);
      }

      function tick() {
        state.price = nextPrice(state.price);
        const now = Date.now();
        if (!candles.length || now - lastCandleTime >= TF) {
          const o = candles.length ? candles[candles.length - 1].c : state.price;
          candles.push({ t: now, o, h: state.price, l: state.price, c: state.price });
          lastCandleTime = now;
        } else {
          const k = candles[candles.length - 1];
          k.c = state.price;
          k.h = Math.max(k.h, state.price);
          k.l = Math.min(k.l, state.price);
        }
        draw();
        updateHud();
      }

      function formatMoney(x) {
        try {
          return (currentLang === 'fr' ? x.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' })
                                       : x.toLocaleString('en-US', { style: 'currency', currency: 'USD' }));
        } catch { return x.toFixed(2); }
      }

      function updateHud() {
        const unreal = state.position * (state.price - state.avg);
        const equity = state.cash + state.realized + unreal;
        document.getElementById('unrealized').textContent = formatMoney(unreal);
        document.getElementById('realized').textContent = formatMoney(state.realized);
        document.getElementById('cash').textContent = formatMoney(state.cash);
        document.getElementById('equity').textContent = formatMoney(equity);
        const posEl = document.getElementById('pos');
        const qty = Math.abs(state.position);
        const dir = state.position > 0 ? 'Long' : state.position < 0 ? 'Short' : 'Flat';
        posEl.textContent = `${dir} ${qty || ''} @ ${state.avg ? state.avg.toFixed(2) : '—'}`;
      }

      function placeOrder(side, qty) {
        qty = Math.max(1, Math.floor(qty));
        const px = state.price;
        if (side === 'buy') {
          if (state.position >= 0) {
            const newPos = state.position + qty;
            state.avg = (state.avg * state.position + px * qty) / (newPos || 1);
            state.position = newPos;
            state.cash -= px * qty;
          } else {
            const closeQty = Math.min(qty, -state.position);
            state.realized += closeQty * (state.avg - px);
            state.position += closeQty;
            state.cash -= px * closeQty;
            const rem = qty - closeQty;
            if (rem > 0) { state.avg = px; state.position += rem; state.cash -= px * rem; }
            else if (state.position === 0) { state.avg = 0; }
          }
        } else if (side === 'sell') {
          if (state.position <= 0) {
            const newPos = state.position - qty;
            state.avg = (Math.abs(state.avg * state.position) + px * qty) / (Math.abs(newPos) || 1);
            state.position = newPos;
            state.cash += px * qty;
          } else {
            const closeQty = Math.min(qty, state.position);
            state.realized += closeQty * (px - state.avg);
            state.position -= closeQty;
            state.cash += px * closeQty;
            const rem = qty - closeQty;
            if (rem > 0) { state.avg = px; state.position -= rem; state.cash += px * rem; }
            else if (state.position === 0) { state.avg = 0; }
          }
        }
        updateHud();
      }

      // Chart drawing
      const canvas = document.getElementById('chart');
      const ctx = canvas.getContext('2d');
      function resize() {
        const wrap = document.querySelector('.chart-wrap');
        const dpr = window.devicePixelRatio || 1;
        const w = Math.floor(wrap.clientWidth);
        const h = Math.floor(Math.max(280, Math.min(560, window.innerHeight * 0.55)));
        canvas.style.width = w + 'px';
        canvas.style.height = h + 'px';
        canvas.width = Math.floor(w * dpr);
        canvas.height = Math.floor(h * dpr);
        ctx.setTransform(dpr,0,0,dpr,0,0);
        draw();
      }

      function draw() {
        const w = canvas.clientWidth; const h = canvas.clientHeight;
        ctx.clearRect(0,0,w,h);
        // background
        ctx.fillStyle = 'rgba(14,18,24,0.9)';
        ctx.fillRect(0,0,w,h);
        // grid
        ctx.strokeStyle = 'rgba(255,255,255,0.06)'; ctx.lineWidth = 1;
        for (let i=1;i<6;i++){ const y = (h/6)*i; ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }

        const visible = Math.min(candles.length, Math.floor(w / 6));
        const start = Math.max(0, candles.length - visible);
        const view = candles.slice(start);
        if (view.length === 0) return;
        let min = Infinity, max = -Infinity;
        for (const k of view) { if (k.l < min) min = k.l; if (k.h > max) max = k.h; }
        const pad = (max - min) * 0.1 || 1; min -= pad; max += pad;
        const xw = Math.max(3, Math.floor(w / view.length) - 2);
        view.forEach((k, i) => {
          const x = i * (xw + 2) + 2;
          const y = (v)=> h - (v - min) / (max - min) * h;
          const up = k.c >= k.o;
          ctx.strokeStyle = up ? 'rgba(0,200,120,0.9)' : 'rgba(240,80,80,0.9)';
          ctx.fillStyle = up ? 'rgba(0,200,120,0.35)' : 'rgba(240,80,80,0.35)';
          // wick
          ctx.beginPath(); ctx.moveTo(x + xw/2, y(k.h)); ctx.lineTo(x + xw/2, y(k.l)); ctx.stroke();
          // body
          const y1 = y(k.o), y2 = y(k.c);
          const top = Math.min(y1,y2), bh = Math.max(2, Math.abs(y1-y2));
          ctx.fillRect(x, top, xw, bh);
        });

        // last price line
        const lp = state.price; const y = (v)=> h - (v - min) / (max - min) * h; const ly = y(lp);
        ctx.strokeStyle = 'rgba(250,250,250,0.4)'; ctx.setLineDash([6,6]);
        ctx.beginPath(); ctx.moveTo(0, ly); ctx.lineTo(w, ly); ctx.stroke(); ctx.setLineDash([]);
      }

      document.getElementById('buy').addEventListener('click', () => {
        const qty = parseInt(document.getElementById('qty').value || '1', 10);
        placeOrder('buy', qty);
      });
      document.getElementById('sell').addEventListener('click', () => {
        const qty = parseInt(document.getElementById('qty').value || '1', 10);
        placeOrder('sell', qty);
      });

      window.addEventListener('resize', resize);
      resize();
      for (let i=0;i<120;i++){ tick(); }
      setInterval(tick, 400);
    </script>
  </body>
  </html>

