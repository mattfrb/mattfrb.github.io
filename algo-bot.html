<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Algo Bot – ORB NQ</title>
    <meta name="description" content="Tableau de bord statique pour la stratégie Opening Range Breakout sur le Nasdaq (NQ)." />
    <style>
      :root {
        color-scheme: dark;
        --bg: #0b0f14;
        --panel: rgba(22, 28, 38, 0.95);
        --border: rgba(255, 255, 255, 0.08);
        --accent: #4285f4;
        --success: #4caf50;
        --danger: #ff5252;
        --warning: #ffa726;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at top, #152031 0%, var(--bg) 55%);
        color: #eef3ff;
        display: flex;
        justify-content: center;
        padding: 32px 16px 48px;
      }
      main {
        width: min(1024px, 100%);
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      header {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: baseline;
      }
      h1 {
        margin: 0;
        font-size: clamp(28px, 4vw, 48px);
        letter-spacing: 0.02em;
      }
      header p {
        margin: 0;
        opacity: 0.7;
      }
      section {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 18px 40px -32px rgba(0, 0, 0, 0.65);
      }
      section h2 {
        margin-top: 0;
        margin-bottom: 12px;
        font-size: 20px;
      }
      .strategy ul {
        margin: 0;
        padding-left: 18px;
        line-height: 1.55;
        opacity: 0.85;
      }
      .metrics {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }
      .metric {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 14px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .metric .label {
        font-size: 13px;
        opacity: 0.7;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .metric .value {
        font-size: 20px;
        font-weight: 600;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 15px;
      }
      thead {
        background: rgba(255, 255, 255, 0.04);
      }
      th, td {
        padding: 10px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        text-align: left;
      }
      tbody tr:nth-child(even) {
        background: rgba(255, 255, 255, 0.023);
      }
      tbody tr:hover {
        background: rgba(66, 133, 244, 0.12);
      }
      .tag {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }
      .tag.long { background: rgba(76, 175, 80, 0.18); color: var(--success); }
      .tag.short { background: rgba(239, 83, 80, 0.18); color: var(--danger); }
      .timestamp {
        font-size: 13px;
        color: rgba(255, 255, 255, 0.55);
      }
      footer {
        text-align: center;
        font-size: 13px;
        opacity: 0.55;
      }
      .error {
        margin-top: 12px;
        padding: 10px 14px;
        border-radius: 12px;
        background: rgba(255, 82, 82, 0.18);
        border: 1px solid rgba(255, 82, 82, 0.4);
        color: #ffbaba;
        display: none;
      }
      @media (max-width: 720px) {
        body { padding: 20px 10px 36px; }
        section { padding: 16px; }
        table { font-size: 14px; }
        th, td { padding: 8px 10px; }
      }
    </style>
  </head>
  <body>
    <main>
      <header>
        <h1>Algo Bot ORB – NQ</h1>
        <p id="last-update" class="timestamp">Chargement…</p>
      </header>

      <section class="strategy">
        <h2>Règles de la stratégie</h2>
        <ul>
          <li>Instrument&nbsp;: E-mini Nasdaq (NQ), données minute (heure US/Eastern).</li>
          <li>Calcul de l’Opening Range sur la fenêtre 09:30–09:45 ET, déclencheur à ±2 points.</li>
          <li>Un trade maximum par sens simultanément&nbsp;: entrée sur breakout long/short après 09:45.</li>
          <li>Gestion&nbsp;: take-profit fixe +20 pts, trailing stop dynamique 15 pts derrière le watermark.</li>
          <li>Passage break-even dès +15 pts ; sortie sinon sur trailing stop ou fin de fenêtre de 390 min.</li>
          <li>Valorisation&nbsp;: 1 point = 20&nbsp;$ sur le contrat NQ. Rapport consolidé sur les 10 dernières séances.</li>
        </ul>
      </section>

      <section>
        <h2>Statistiques (10 dernières séances)</h2>
        <div class="metrics">
          <div class="metric">
            <div class="label">Win rate</div>
            <div class="value" id="metric-winrate">—</div>
          </div>
          <div class="metric">
            <div class="label">Trades gagnés / total</div>
            <div class="value" id="metric-ratio">—</div>
          </div>
          <div class="metric">
            <div class="label">Profit total</div>
            <div class="value" id="metric-profit-usd">—</div>
            <span class="timestamp" id="metric-profit-pts">—</span>
          </div>
          <div class="metric">
            <div class="label">Dernière séance</div>
            <div class="value" id="metric-last-date">—</div>
          </div>
        </div>
        <div class="error" id="summary-error">Impossible de lire <code>opening_range_reports/summary_last_10_days.csv</code>.</div>
      </section>

      <section>
        <h2>Derniers trades de la séance</h2>
        <div class="metrics" style="margin-bottom:12px;">
          <div class="metric">
            <div class="label">Direction</div>
            <div class="value" id="trade-direction">—</div>
          </div>
          <div class="metric">
            <div class="label">Entrée</div>
            <div class="value" id="trade-entry">—</div>
          </div>
          <div class="metric">
            <div class="label">Sortie</div>
            <div class="value" id="trade-exit">—</div>
          </div>
          <div class="metric">
            <div class="label">PnL</div>
            <div class="value" id="trade-pnl">—</div>
            <span class="timestamp" id="trade-reason">—</span>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Direction</th>
              <th>Entrée</th>
              <th>Sortie</th>
              <th>Raison</th>
              <th>PnL (pts)</th>
              <th>PnL ($)</th>
            </tr>
          </thead>
          <tbody id="trades-body">
            <tr><td colspan="7" style="text-align:center; padding:24px 12px;">Chargement en cours…</td></tr>
          </tbody>
        </table>
        <div class="error" id="trades-error">Impossible de lire les fichiers <code>trades_YYYY-MM-DD.csv</code>.</div>
      </section>

      <footer>
        Actualisation automatique toutes les 60&nbsp;secondes (données locales statiques).
      </footer>
    </main>

    <script>
      const POINT_VALUE = 20;
      const DATA_ROOT = 'opening_range_reports';
      const SUMMARY_FILE = `${DATA_ROOT}/summary_last_10_days.csv`;

      const $ = (id) => document.getElementById(id);

      function formatNumber(value, digits = 2) {
        const num = Number(value);
        if (!Number.isFinite(num)) return '—';
        return num.toFixed(digits);
      }

      function formatUSD(value) {
        const num = Number(value);
        if (!Number.isFinite(num)) return '—';
        return `$${num.toFixed(2)}`;
      }

      function formatTime(isoString) {
        if (!isoString) return '—';
        const dt = new Date(isoString);
        if (Number.isNaN(dt.getTime())) return isoString;
        return dt.toLocaleTimeString('fr-FR', { timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit' });
      }

      function parseCSV(text) {
        const lines = text.trim().split(/\r?\n/);
        if (!lines.length) return [];
        const headers = lines.shift().split(',').map((h) => h.trim());
        return lines.filter(Boolean).map((line) => {
          const cols = line.split(',');
          return headers.reduce((acc, header, idx) => {
            acc[header] = cols[idx] !== undefined ? cols[idx].trim() : '';
            return acc;
          }, {});
        });
      }

      async function fetchCSV(path) {
        const response = await fetch(path + `?t=${Date.now()}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return parseCSV(await response.text());
      }

      async function loadSummary() {
        const summaryRows = await fetchCSV(SUMMARY_FILE);
        const totals = summaryRows.reduce(
          (acc, row) => {
            const trades = Number(row.trades);
            const wins = Number(row.wins);
            const profitPts = Number(row.profit);
            if (Number.isFinite(trades)) acc.trades += trades;
            if (Number.isFinite(wins)) acc.wins += wins;
            if (Number.isFinite(profitPts)) acc.profitPts += profitPts;
            return acc;
          },
          { trades: 0, wins: 0, profitPts: 0 }
        );
        const lastDate = summaryRows.length ? summaryRows[summaryRows.length - 1].date : null;
        return { rows: summaryRows, totals, lastDate };
      }

      async function loadTrades(date) {
        if (!date) return [];
        return await fetchCSV(`${DATA_ROOT}/trades_${date}.csv`);
      }

      function updateSummaryUI(summary) {
        const { totals, rows, lastDate } = summary;
        const winRate = totals.trades ? (totals.wins / totals.trades) * 100 : null;
        $('metric-winrate').textContent = winRate !== null ? `${formatNumber(winRate, 2)}%` : '—';
        $('metric-ratio').textContent = `${totals.wins} / ${totals.trades}`;
        $('metric-profit-usd').textContent = formatUSD(totals.profitPts * POINT_VALUE);
        $('metric-profit-pts').textContent = `${formatNumber(totals.profitPts, 2)} pts`;
        $('metric-last-date').textContent = lastDate || '—';

        $('summary-error').style.display = 'none';
      }

      function updateTradesUI(trades) {
        const tbody = $('trades-body');
        tbody.innerHTML = '';
        if (!trades.length) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:24px 12px;">Aucun trade disponible.</td></tr>';
          $('trades-error').style.display = 'block';
          return;
        }

        trades.forEach((trade) => {
          const direction = (trade.direction || '').toLowerCase();
          const tagClass = direction === 'long' ? 'tag long' : 'tag short';
          const pnlPts = Number(trade.profit_points || trade.profit || 0);
          const pnlUsd = pnlPts * POINT_VALUE;

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${trade.date || '—'}</td>
            <td><span class="${tagClass}">${direction.toUpperCase() || '—'}</span></td>
            <td>${formatNumber(trade.entry_price)} @ ${formatTime(trade.entry_time)}</td>
            <td>${formatNumber(trade.exit_price)} @ ${formatTime(trade.exit_time)}</td>
            <td>${(trade.reason || '—').replace(/_/g, ' ')}</td>
            <td>${formatNumber(pnlPts, 2)}</td>
            <td>${formatUSD(pnlUsd)}</td>
          `;
          tbody.appendChild(tr);
        });

        const lastTrade = trades[trades.length - 1];
        const direction = (lastTrade.direction || '').toUpperCase();
        const pnlPts = Number(lastTrade.profit_points || lastTrade.profit || 0);
        const pnlUsd = pnlPts * POINT_VALUE;

        $('trade-direction').innerHTML = direction ? `<span class="tag ${direction === 'LONG' ? 'long' : 'short'}">${direction}</span>` : '—';
        $('trade-entry').textContent = `${formatNumber(lastTrade.entry_price)} @ ${formatTime(lastTrade.entry_time)}`;
        $('trade-exit').textContent = `${formatNumber(lastTrade.exit_price)} @ ${formatTime(lastTrade.exit_time)}`;
        $('trade-pnl').textContent = `${formatUSD(pnlUsd)} (${formatNumber(pnlPts, 2)} pts)`;
        $('trade-reason').textContent = (lastTrade.reason || '—').replace(/_/g, ' ');

        $('trades-error').style.display = 'none';
      }

      async function refresh() {
        try {
          const summary = await loadSummary();
          updateSummaryUI(summary);

          const trades = await loadTrades(summary.lastDate);
          updateTradesUI(trades);

          const now = new Date();
          $('last-update').textContent = `Dernière actualisation : ${now.toLocaleString('fr-FR', { hour12: false })}`;
        } catch (error) {
          console.error(error);
          $('summary-error').style.display = 'block';
          $('trades-error').style.display = 'block';
        }
      }

      refresh();
      setInterval(refresh, 60000);
    </script>
  </body>
</html>
