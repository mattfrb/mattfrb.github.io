<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ORB NQ – Suivi Live</title>
    <style>
      :root { --bg:#0b1020; --card:#121a33; --fg:#e8eefc; --muted:#9fb0d9; --pos:#4caf50; --neg:#f44336; --accent:#4aa3ff; }
      html,body{height:100%;margin:0}
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:var(--fg);overflow:hidden;opacity:0;transition:opacity .25s ease}
      header{padding:20px 16px;border-bottom:1px solid #1d2a55}
      h1{margin:0;font-size:20px}
      main{width:100%;max-width:none;margin:0;padding:12px 16px;display:grid;gap:16px}
      .card{background:var(--card);border:1px solid #1d2a55;border-radius:10px;padding:16px}
      .row{display:flex;flex-wrap:wrap;gap:12px}
      .metric{flex:1 1 160px;background:#0e1730;border:1px solid #1c2a55;border-radius:8px;padding:12px}
      .label{font-size:12px;color:var(--muted)}
      .value{font-size:20px;margin-top:4px}
      .green{color:var(--pos)} .red{color:var(--neg)}
      code{background:#0b1430;border:1px solid #1d2a55;border-radius:6px;padding:2px 6px}
      table{width:100%;border-collapse:collapse}
      th,td{border-bottom:1px solid #20315f;padding:8px 6px;text-align:left}
      th{color:var(--muted);font-weight:600}
      .hint{color:var(--muted);font-size:12px}
      a{color:var(--accent)}

      /* Footer (match site presentation) */
      /* footer removed for maximum viewport usage */
    </style>
  </head>
  <body>
    <header>
      <h1>Opening Range Breakout – NQ (live)</h1>
      <div class="hint">Mise à jour automatique à partir de GitHub Actions (1–2 min).</div>
    </header>
    <main>
      <section class="card" id="status-card">
        <div class="row">
          <div class="metric"><div class="label">Statut</div><div class="value" id="status">—</div></div>
          <div class="metric"><div class="label">Date (ET)</div><div class="value" id="date">—</div></div>
          <div class="metric"><div class="label">Heure</div><div class="value" id="now">—</div></div>
          <div class="metric"><div class="label">Winrate (10 j)</div><div class="value" id="winrate">—</div></div>
          <div class="metric"><div class="label">PnL total (10 j)</div><div class="value" id="pnl10">—</div></div>
        </div>
      </section>

      <section class="card">
        <h3>Fourchette d'ouverture</h3>
        <div class="row">
          <div class="metric"><div class="label">High (9:30–9:45)</div><div class="value" id="orbHigh">—</div></div>
          <div class="metric"><div class="label">Low (9:30–9:45)</div><div class="value" id="orbLow">—</div></div>
          <div class="metric"><div class="label">Long lvl (H+2)</div><div class="value" id="longLvl">—</div></div>
          <div class="metric"><div class="label">Short lvl (L-2)</div><div class="value" id="shortLvl">—</div></div>
        </div>
      </section>

      <section class="card">
        <h3>Trade du jour</h3>
        <div class="row" id="tradeBox">
          <div class="metric"><div class="label">Direction</div><div class="value" id="dir">—</div></div>
          <div class="metric"><div class="label">Entrée</div><div class="value" id="entry">—</div></div>
          <div class="metric"><div class="label">Stop</div><div class="value" id="stop">—</div></div>
          <div class="metric"><div class="label">Watermark</div><div class="value" id="wm">—</div></div>
          <div class="metric"><div class="label">PnL (pts)</div><div class="value" id="upnlPts">—</div></div>
          <div class="metric"><div class="label">PnL ($)</div><div class="value" id="upnlUsd">—</div></div>
        </div>
        <div class="hint">Un seul trade par séance; sortie sur TP, trailing stop ou fin de fenêtre.</div>
      </section>

      <section class="card">
        <h3>Derniers 10 trades</h3>
        <div class="hint">Source: opening_range_reports/summary_last_10_days.csv</div>
        <table id="tbl">
          <thead>
            <tr><th>Date</th><th>Dir</th><th>Entrée</th><th>Sortie</th><th>Pts</th><th>$</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>
    </main>
    <script>
      // Fade transitions like other pages
      function setupTransitions(){
        requestAnimationFrame(()=>{document.body.style.opacity='1'});
        document.querySelectorAll('a[href]').forEach(a=>{
          const href=a.getAttribute('href');
          if(!href||href.startsWith('http')||href.startsWith('#')||a.target==='_blank') return;
          a.addEventListener('click',e=>{e.preventDefault();document.body.style.opacity='0';setTimeout(()=>{window.location.href=a.href},200)});
        });
      }
      async function loadJSON(path){
        const resp = await fetch(path + `?t=${Date.now()}`);
        if(!resp.ok) throw new Error("HTTP " + resp.status);
        return resp.json();
      }
      function fmt(n){return typeof n === 'number' ? n.toFixed(2) : n}
      function pct(n){return (n*100).toFixed(1)+"%"}

      async function refresh(){
        try{
          const latest = await loadJSON('opening_range_reports/latest.json');
          const summary = latest.summary || (await loadJSON('opening_range_reports/summary.json').catch(()=>null));

          document.getElementById('status').textContent = latest.status || '—';
          const d = latest.session_date || '—';
          document.getElementById('date').textContent = d;
          document.getElementById('now').textContent = new Date(latest.now_et||'').toLocaleTimeString('fr-FR',{timeZone:'America/New_York'});

          const winrate = summary?.winrate != null ? pct(summary.winrate) : '—';
          const pnl10 = summary ? `$${fmt(summary.total_pnl_usd)}` : '—';
          document.getElementById('winrate').textContent = winrate;
          document.getElementById('pnl10').textContent = pnl10;

          const orb = latest.opening_range || {};
          document.getElementById('orbHigh').textContent = fmt(orb.high);
          document.getElementById('orbLow').textContent = fmt(orb.low);
          document.getElementById('longLvl').textContent = fmt(orb.long_level);
          document.getElementById('shortLvl').textContent = fmt(orb.short_level);

          const t = latest.trade || {};
          const open = t.open;
          document.getElementById('dir').textContent = open ? t.direction : (t.trade_executed ? 'Terminé' : 'Aucun');
          document.getElementById('entry').textContent = open ? `${fmt(t.entry_price)} @ ${new Date(t.entry_time).toLocaleTimeString('fr-FR',{timeZone:'America/New_York'})}` : '—';
          document.getElementById('stop').textContent = open ? fmt(t.stop_price) : '—';
          document.getElementById('wm').textContent = open ? fmt(t.watermark_price) : '—';
          const pts = open ? t.unrealized_pnl_points : 0;
          const usd = open ? t.unrealized_pnl_usd : 0;
          const ptsEl = document.getElementById('upnlPts');
          const usdEl = document.getElementById('upnlUsd');
          ptsEl.textContent = open ? fmt(pts) : '—';
          usdEl.textContent = open ? `$${fmt(usd)}` : '—';
          ptsEl.className = 'value ' + (pts>0?'green':pts<0?'red':'');
          usdEl.className = 'value ' + (usd>0?'green':usd<0?'red':'');

          // Table
          const tbody = document.querySelector('#tbl tbody');
          tbody.innerHTML = '';
          (summary?.last_10||[]).slice().reverse().forEach(r=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${r.date}</td><td>${r.direction||''}</td><td>${fmt(r.entry_price)||''}</td><td>${fmt(r.exit_price)||''}</td><td>${fmt(r.pnl_points)||''}</td><td>$${fmt(r.pnl_usd)||''}</td>`;
            tbody.appendChild(tr);
          });
        }catch(e){
          console.error(e);
          document.getElementById('status').textContent = 'Erreur chargement';
        }
      }
      setupTransitions();
      refresh();
      setInterval(refresh, 60000);
    </script>
  </body>
  </html>
